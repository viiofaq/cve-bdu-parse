import os
import time
import psycopg2
import telebot
from telebot import types

with open("settings.txt", 'r') as fp:
    txt_lines = [1, 4, 7, 10, 13]
    lines = []
    for i, line in enumerate(fp):
        if i in txt_lines:
            lines.append(line.strip())

dbname = lines[0]
user = lines[1]
password = lines[2]
host = lines[3]
tgtoken = lines[4]

tb = telebot.TeleBot(tgtoken)
tb.get_updates()

chatarrays = []

conn = psycopg2.connect(dbname=dbname, user=user,
                        password=password, host=host)
cursor = conn.cursor()


@tb.message_handler(commands=['start'])  # стартовая команда
def start(message):
    markup = types.InlineKeyboardMarkup()
    answer = ' Hey Hey '
    tb.send_message(message.from_user.id, answer)

    chatid = message.from_user.id
    cursor.execute("INSERT INTO chatlist(chatid) VALUES(%s)", (chatid,))
    cursor.execute(
        "DELETE FROM chatlist a WHERE a.ctid <> (SELECT min(b.ctid) FROM chatlist b WHERE  a.chatid "
        "= b.chatid);")

    conn.commit()


sendedid = []


def sendvulner():
    query = 'SELECT * FROM chatlist;'
    cursor.execute(query)
    for row in cursor:
        gettestid = row[0]
        if gettestid not in chatarrays:
            chatarrays.append(gettestid)

    querysend = 'SELECT * FROM senddone;'
    cursor.execute(querysend)
    for row in cursor:

        sendid = row[0]
        if sendid not in sendedid:
            sendedid.append(sendid)
    print(sendedid)

    query = 'SELECT * FROM summarinfo;'
    cursor.execute(query)
    for row in cursor:
        ident = row[0]
        # print(row)
        if ident not in sendedid:
            otherid = row[1]
            datepubl = row[2]
            cvss = row[3]
            soft = row[4]
            softver = row[5]
            desc = row[6]
            cwe = row[7]
            links = row[8]
            print(row)
            if otherid is None:
                otherid = 'нет информации'
            if datepubl is None:
                datepubl = 'нет информации'
            if cvss is None:
                cvss = 'нет информации'
            if soft is None:
                soft = 'нет информации'
            if softver is None:
                softver = 'нет информации'
            if desc is None:
                desc = 'нет информации'
            if cwe is None:
                cwe = 'нет информации'
            if links is None:
                links = 'нет информации'

            texttosend = 'ИДЕНТИФИКАТОР УЯЗВИМОСТИ\n' + ident + '\n' + '\nАЛЬТЕРАНТИВНЫЕ ИДЕНТИФИКАТОРЫ\n' + otherid + '\n' + '\nДАТА ПУБЛИКАЦИИ\n' + datepubl + '\n' + '\nУРОВЕНЬ CVSS\n' + cvss + '\n' + '\nПО\n' + soft + '\n' + '\nВЕРСИЯ ПО\n' + softver + '\n' + '\nОПИСАНИЕ УЯЗВИМОСТИ\n' + desc + '\n' + '\nТИП ОШИБКИ\n' + cwe + '\n' + '\nДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ\n' + links
            tempid = len(chatarrays)
            for i in range(0, tempid, 1):
                recieverid = chatarrays[i]
                try:
                    tb.send_message(recieverid, texttosend)
                except:
                    check = 'ОШИБКА ПРИ ОТПРАВКЕ ИДЕНТИФИКАТОРА\n' + ident + '\n' + links
                    tb.send_message(recieverid, check)

            cursor.execute("INSERT INTO senddone(sendedid) VALUES(%s)", (ident,))
            conn.commit()
        else:
            pass


while True:
    try:
        sendvulner()
    except:
        pass
    time.sleep(10)

tb.infinity_polling()
