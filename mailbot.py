import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import time
import psycopg2



with open("settings.txt", 'r') as fp:
    txt_lines = [1, 4, 7, 10, 13, 16, 19]
    lines = []
    for i, line in enumerate(fp):
        if i in txt_lines:
            lines.append(line.strip())


dbname = lines[0]
user = lines[1]
password = lines[2]
host = lines[3]

conn = psycopg2.connect(dbname=dbname, user=user,
                        password=password, host=host)

cursor = conn.cursor()


msg = MIMEMultipart()
msg['From'] = lines[5]
password = lines[6]


server = smtplib.SMTP('smtp.gmail.com', 587)  # авторизация gmail
server.starttls()
server.login(msg['From'], password)


sendedid = []
rec_mails = []


def mailbot():

    querysend = 'SELECT * FROM mails;'
    cursor.execute(querysend)
    for row in cursor:
        mailrec = row[0]
        if mailrec not in sendedid:
            rec_mails.append(mailrec)

    querysend = 'SELECT * FROM senddone;'
    cursor.execute(querysend)
    for row in cursor:
        sendid = row[0]
        if sendid not in sendedid:
            sendedid.append(sendid)


    query = 'SELECT * FROM summarinfo;'
    cursor.execute(query)
    for row in cursor:
        ident = row[0]
        # print(row)
        if ident not in sendedid:
            otherid = row[1]
            datepubl = row[2]
            cvss = row[3]
            soft = row[4]
            softver = row[5]
            desc = row[6]
            cwe = row[7]
            links = row[8]
            #print(row)
            if otherid is None:
                otherid = 'нет информации'
            if datepubl is None:
                datepubl = 'нет информации'
            if cvss is None:
                cvss = 'нет информации'
            if soft is None:
                soft = 'нет информации'
            if softver is None:
                softver = 'нет информации'
            if desc is None:
                desc = 'нет информации'
            if cwe is None:
                cwe = 'нет информации'
            if links is None:
                links = 'нет информации'

            texttosend = 'ИДЕНТИФИКАТОР УЯЗВИМОСТИ\n' + ident + '\n' + '\nАЛЬТЕРАНТИВНЫЕ ИДЕНТИФИКАТОРЫ\n' + otherid + '\n' + '\nДАТА ПУБЛИКАЦИИ\n' + datepubl + '\n' + '\nУРОВЕНЬ CVSS\n' + cvss + '\n' + '\nПО\n' + soft + '\n' + '\nВЕРСИЯ ПО\n' + softver + '\n' + '\nОПИСАНИЕ УЯЗВИМОСТИ\n' + desc + '\n' + '\nТИП ОШИБКИ\n' + cwe + '\n' + '\nДОПОЛНИТЕЛЬНАЯ ИНФОРМАЦИЯ\n' + links

            msg.attach(MIMEText(texttosend, 'plain', 'utf-8'))

            recsi = len(rec_mails)
            for c in range(0, recsi, 1):
                reciever_mail = rec_mails[c]
                try:
                    server.sendmail(msg['From'], reciever_mail, msg.as_string())
                    cursor.execute("INSERT INTO senddone(sendedid) VALUES(%s)", (ident,))
                    conn.commit()
                except:
                    pass


while True:
    try:
        mailbot()
    except:
        pass
    time.sleep(10)
